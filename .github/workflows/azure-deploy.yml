name: ğŸš€ Azure Container Apps Deploy

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_RESOURCE_GROUP: rg-webapp-prod
  AZURE_CONTAINER_APP: ws-landing-prod
  AZURE_REGISTRY: acracaminyouprod
  AZURE_REGISTRY_URL: acracaminyouprod.azurecr.io
  IMAGE_NAME: acaminyou-landing
  DOCKER_FILE: Dockerfile.prod
  

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 0: Verificar se deve executar o deploy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-deploy-flag:
    name: ğŸ” Verificar Flag de Deploy
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # NecessÃ¡rio para pegar a mensagem do commit
      
      - name: ğŸ” Verificar mensagem do commit
        id: check
        run: |
          # Obter mensagem do Ãºltimo commit
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Workflow manual sempre executa
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deploy manual - executando workflow"
            exit 0
          fi
          
          # Obter apenas a primeira linha do commit (subject)
          COMMIT_MSG=$(git log -1 --pretty=%s)
          
          echo "ğŸ“ Mensagem do commit:"
          echo "${COMMIT_MSG}"
          echo ""
          
          # Verificar se contÃ©m algum dos flags de deploy
          if echo "${COMMIT_MSG}" | grep -qiE '\[deploy\]|\[azure\]|\[build\]'; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Flag de deploy encontrado - executando workflow"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Nenhum flag de deploy encontrado - pulando workflow"
            echo ""
            echo "ğŸ’¡ Para executar o deploy, adicione um dos seguintes flags na mensagem do commit:"
            echo "   - [deploy]  - Deploy padrÃ£o"
            echo "   - [azure]   - Deploy no Azure"
            echo "   - [build]   - Build e deploy"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Build e Push da Imagem Docker
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: ğŸ”¨ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: check-deploy-flag
    if: needs.check-deploy-flag.outputs.should-deploy == 'true'
    outputs:
      revision-number: ${{ steps.generate-revision.outputs.revision }}
      image-tag: ${{ steps.generate-revision.outputs.tag }}
      package-size: ${{ steps.image-info.outputs.size }}
      build-time: ${{ steps.image-info.outputs.build-time }}
      
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout do cÃ³digo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # NecessÃ¡rio para contar commits
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Gerar nÃºmero de revisÃ£o (formato: 0000XXX)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”¢ Generate Revision Number
        id: generate-revision
        run: |
          # Conta o nÃºmero de commits na branch atual
          COMMIT_COUNT=$(git rev-list --count HEAD)
          
          # Formata como 7 dÃ­gitos (0000001, 0000002, etc.)
          REVISION=$(printf "%07d" $COMMIT_COUNT)
          
          # SHA curto do commit
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Tag da imagem: revision-sha (ex: 0000024-a1b2c3d)
          IMAGE_TAG="${REVISION}-${SHORT_SHA}"
          
          echo "revision=${REVISION}" >> $GITHUB_OUTPUT
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ RevisÃ£o gerada: ${REVISION}"
          echo "ğŸ·ï¸ Tag da imagem: ${IMAGE_TAG}"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Login no Azure
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Login no Azure Container Registry
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ³ Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.AZURE_REGISTRY }}
          echo "âœ… Login no ACR realizado com sucesso"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Setup Docker Buildx (para build otimizado)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Build e Push da imagem Docker
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”¨ Build and Push Docker Image
        id: docker-build
        run: |
          BUILD_START=$(date +%s)
          
          IMAGE_FULL_PATH="${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.generate-revision.outputs.tag }}"
          IMAGE_LATEST="${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "ğŸ”¨ Iniciando build da imagem..."
          echo "ğŸ“ Path: ${IMAGE_FULL_PATH}"
          
          docker build \
            -f ${{ env.DOCKER_FILE }} \
            -t "${IMAGE_FULL_PATH}" \
            -t "${IMAGE_LATEST}" \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg REVISION=${{ steps.generate-revision.outputs.revision }} \
            --build-arg COMMIT_SHA=${{ steps.generate-revision.outputs.short-sha }} \
            --build-arg NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }} \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }} \
            .
          
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          
          echo "build-time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¤ Enviando imagem para ACR..."
          docker push "${IMAGE_FULL_PATH}"
          docker push "${IMAGE_LATEST}"
          
          echo "âœ… Build concluÃ­do em ${BUILD_TIME}s"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Obter informaÃ§Ãµes da imagem
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Get Image Information
        id: image-info
        run: |
          IMAGE_FULL_PATH="${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.generate-revision.outputs.tag }}"
          
          # Tamanho da imagem
          SIZE_BYTES=$(docker image inspect "${IMAGE_FULL_PATH}" --format='{{.Size}}')
          SIZE_MB=$(awk "BEGIN {printf \"%.2f\", ${SIZE_BYTES}/1024/1024}")
          
          echo "size=${SIZE_MB} MB" >> $GITHUB_OUTPUT
          echo "build-time=${{ steps.docker-build.outputs.build-time }}s" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Tamanho da imagem: ${SIZE_MB} MB"
          
          # InformaÃ§Ãµes adicionais
          docker image inspect "${IMAGE_FULL_PATH}" --format='
          ğŸ“‹ InformaÃ§Ãµes da Imagem:
          â”œâ”€ ID: {{.Id}}
          â”œâ”€ Criada: {{.Created}}
          â”œâ”€ Arquitetura: {{.Architecture}}
          â”œâ”€ OS: {{.Os}}
          â””â”€ Layers: {{len .RootFS.Layers}}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Deploy no Azure Container Apps
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy to Azure
    runs-on: ubuntu-latest
    needs: [check-deploy-flag, build-and-push]
    if: needs.check-deploy-flag.outputs.should-deploy == 'true'
    outputs:
      revision-name: ${{ steps.deploy.outputs.revision-name }}
      app-url: ${{ steps.deploy.outputs.app-url }}
      
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Login no Azure
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1.5 Verificar Container App existe
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Verify Container App Exists
        run: |
          echo "ğŸ” Verificando se Container App existe..."
          echo "ğŸ“¦ App: ${{ env.AZURE_CONTAINER_APP }}"
          echo "ğŸ“‚ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          
          # Listar Container Apps no resource group
          az containerapp list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[].{Name:name, ResourceGroup:resourceGroup}" \
            --output table
          
          # Verificar se o app existe
          if az containerapp show \
            --name ${{ env.AZURE_CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --output none 2>/dev/null; then
            echo "âœ… Container App encontrado!"
          else
            echo "âŒ Container App nÃ£o encontrado!"
            exit 1
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Deploy no Container Apps
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Deploy to Azure Container Apps
        id: deploy
        run: |
          IMAGE_PATH="${{ env.AZURE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}"
          REVISION_SUFFIX="rev-${{ needs.build-and-push.outputs.revision-number }}"
          
          echo "ğŸš€ Iniciando deploy..."
          echo "ğŸ“ Imagem: ${IMAGE_PATH}"
          echo "ğŸ“‹ RevisÃ£o: ${REVISION_SUFFIX}"
          
          # Deploy com criaÃ§Ã£o de nova revisÃ£o
          DEPLOY_OUTPUT=$(az containerapp update \
            --name ${{ env.AZURE_CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image "${IMAGE_PATH}" \
            --revision-suffix "${REVISION_SUFFIX}" \
            --output json)
          
          # Extrair informaÃ§Ãµes do deploy
          REVISION_NAME=$(echo "$DEPLOY_OUTPUT" | jq -r '.properties.latestRevisionName')
          APP_FQDN=$(echo "$DEPLOY_OUTPUT" | jq -r '.properties.configuration.ingress.fqdn')
          APP_URL="https://${APP_FQDN}"
          
          echo "revision-name=${REVISION_NAME}" >> $GITHUB_OUTPUT
          echo "app-url=${APP_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ… Deploy concluÃ­do!"
          echo "ğŸ“ RevisÃ£o: ${REVISION_NAME}"
          echo "ğŸŒ URL: ${APP_URL}"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Verificar status da revisÃ£o
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Check Revision Status
        run: |
          REVISION_NAME="${{ steps.deploy.outputs.revision-name }}"
          
          echo "â³ Aguardando ativaÃ§Ã£o da revisÃ£o..."
          
          # Aguardar atÃ© 5 minutos pela ativaÃ§Ã£o
          for i in {1..30}; do
            STATUS=$(az containerapp revision show \
              --name ${{ env.AZURE_CONTAINER_APP }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "${REVISION_NAME}" \
              --query 'properties.provisioningState' \
              --output tsv)
            
            echo "Status da revisÃ£o: ${STATUS}"
            
            if [ "$STATUS" == "Provisioned" ]; then
              echo "âœ… RevisÃ£o ativada com sucesso!"
              
              # Mostrar detalhes da revisÃ£o
              az containerapp revision show \
                --name ${{ env.AZURE_CONTAINER_APP }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --revision "${REVISION_NAME}" \
                --query '{
                  Revisao: name,
                  Status: properties.provisioningState,
                  Ativo: properties.active,
                  TrafficWeight: properties.trafficWeight,
                  Replicas: properties.replicas,
                  CriadaEm: properties.createdTime
                }' \
                --output table
              
              break
            elif [ "$STATUS" == "Failed" ]; then
              echo "âŒ Falha na ativaÃ§Ã£o da revisÃ£o!"
              exit 1
            fi
            
            sleep 10
          done
          
          if [ "$STATUS" != "Provisioned" ]; then
            echo "âš ï¸ Timeout aguardando ativaÃ§Ã£o da revisÃ£o"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Health Check e ValidaÃ§Ã£o
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  health-check:
    name: ğŸ¥ Health Check & Validation
    runs-on: ubuntu-latest
    needs: [check-deploy-flag, build-and-push, deploy]
    if: needs.check-deploy-flag.outputs.should-deploy == 'true'
    outputs:
      http-code: ${{ steps.health-check.outputs.http-code }}
      response-time: ${{ steps.health-check.outputs.response-time }}
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Aguardar aplicaÃ§Ã£o inicializar
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â³ Wait for Application Startup
        run: |
          echo "â³ Aguardando 30 segundos para inicializaÃ§Ã£o..."
          sleep 30
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Health Check HTTP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¥ HTTP Health Check
        id: health-check
        run: |
          APP_URL="${{ needs.deploy.outputs.app-url }}"
          
          echo "ğŸ¥ Executando health check..."
          echo "ğŸŒ URL: ${APP_URL}"
          
          # Realizar atÃ© 10 tentativas
          SUCCESS=false
          for i in {1..10}; do
            echo "Tentativa ${i}/10..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${APP_URL}" --max-time 30)
            RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" -L "${APP_URL}" --max-time 30)
            
            echo "  â””â”€ HTTP Code: ${HTTP_CODE}"
            echo "  â””â”€ Response Time: ${RESPONSE_TIME}s"
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
              SUCCESS=true
              echo "http-code=${HTTP_CODE}" >> $GITHUB_OUTPUT
              echo "response-time=${RESPONSE_TIME}" >> $GITHUB_OUTPUT
              echo "âœ… Health check OK!"
              break
            fi
            
            sleep 10
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Health check falhou apÃ³s 10 tentativas"
            exit 1
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Verificar recursos crÃ­ticos
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Check Critical Resources
        run: |
          APP_URL="${{ needs.deploy.outputs.app-url }}"
          
          echo "ğŸ” Verificando recursos crÃ­ticos..."
          
          # Lista de recursos para verificar
          RESOURCES=(
            "/"
            "/favicon.ico"
          )
          
          for RESOURCE in "${RESOURCES[@]}"; do
            URL="${APP_URL}${RESOURCE}"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${URL}" --max-time 10)
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 301 ] || [ "$HTTP_CODE" -eq 302 ]; then
              echo "âœ… ${RESOURCE} - HTTP ${HTTP_CODE}"
            else
              echo "âš ï¸ ${RESOURCE} - HTTP ${HTTP_CODE}"
            fi
          done
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Login no Azure e verificar logs
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ“‹ Check Container Logs
        run: |
          REVISION_NAME="${{ needs.deploy.outputs.revision-name }}"
          
          echo "ğŸ“‹ Ãšltimas 20 linhas de log da revisÃ£o:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          az containerapp logs show \
            --name ${{ env.AZURE_CONTAINER_APP }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --revision "${REVISION_NAME}" \
            --tail 20 \
            --follow false \
            || echo "âš ï¸ Logs ainda nÃ£o disponÃ­veis"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: Resumo do Deploy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [check-deploy-flag, build-and-push, deploy, health-check]
    if: always() && needs.check-deploy-flag.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“Š Generate Deployment Summary
        run: |
          cat << EOF > $GITHUB_STEP_SUMMARY
          # ğŸš€ Azure Container Apps Deploy - Resumo
          
          ## ğŸ“¦ InformaÃ§Ãµes da Build
          
          | Item | Valor |
          |------|-------|
          | **RevisÃ£o** | \`${{ needs.build-and-push.outputs.revision-number }}\` |
          | **Tag da Imagem** | \`${{ needs.build-and-push.outputs.image-tag }}\` |
          | **Tamanho do Pacote** | ${{ needs.build-and-push.outputs.package-size }} |
          | **Tempo de Build** | ${{ needs.build-and-push.outputs.build-time }} |
          | **Commit SHA** | \`${{ github.sha }}\` |
          | **Branch** | \`${{ github.ref_name }}\` |
          
          ## ğŸš€ InformaÃ§Ãµes do Deploy
          
          | Item | Valor |
          |------|-------|
          | **RevisÃ£o Azure** | \`${{ needs.deploy.outputs.revision-name }}\` |
          | **URL da AplicaÃ§Ã£o** | ${{ needs.deploy.outputs.app-url }} |
          | **Resource Group** | \`${{ env.AZURE_RESOURCE_GROUP }}\` |
          | **Container App** | \`${{ env.AZURE_CONTAINER_APP }}\` |
          
          ## ğŸ¥ Health Check
          
          | Item | Valor |
          |------|-------|
          | **Status** | ${{ needs.health-check.result == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }} |
          | **HTTP Code** | \`${{ needs.health-check.outputs.http-code || 'N/A' }}\` |
          | **Tempo de Resposta** | ${{ needs.health-check.outputs.response-time || 'N/A' }}s |
          
          ## ğŸ”— Links Ãšteis
          
          - ğŸŒ [Acessar AplicaÃ§Ã£o](${{ needs.deploy.outputs.app-url }})
          - ğŸ“Š [Azure Portal - Container Apps](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.App/containerApps/${{ env.AZURE_CONTAINER_APP }}/overview)
          - ğŸ“‹ [Logs da RevisÃ£o](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.App/containerApps/${{ env.AZURE_CONTAINER_APP }}/revisionManagement)
          
          ## ğŸ“ Detalhes do Workflow
          
          - **Workflow Run**: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Triggered by**: ${{ github.actor }}
          - **Event**: ${{ github.event_name }}
          - **Data/Hora**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          
          EOF
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… Deploy concluÃ­do com sucesso!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deploy concluÃ­do com problemas no health check" >> $GITHUB_STEP_SUMMARY
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Notificar no console
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¢ Console Notification
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOY FINALIZADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ RevisÃ£o: ${{ needs.build-and-push.outputs.revision-number }}"
          echo "ğŸ·ï¸ Tag: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "ğŸ“Š Tamanho: ${{ needs.build-and-push.outputs.package-size }}"
          echo "â±ï¸ Build: ${{ needs.build-and-push.outputs.build-time }}"
          echo ""
          echo "ğŸš€ RevisÃ£o Azure: ${{ needs.deploy.outputs.revision-name }}"
          echo "ğŸŒ URL: ${{ needs.deploy.outputs.app-url }}"
          echo ""
          echo "ğŸ¥ Health Check: ${{ needs.health-check.result }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
